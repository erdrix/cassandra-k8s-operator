<!doctype html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width">
<meta name="generator" content="Docusaurus">


<title data-react-helmet="true">Cluster topology - Cassandra rack aware deployments</title>

<meta data-react-helmet="true" http-equiv="x-ua-compatible" content="ie=edge"><meta data-react-helmet="true" property="og:title" content="Casskop Â· Open-Source, Apache Cassandra operator for Kubernetes"><meta data-react-helmet="true" name="twitter:card" content="summary"><meta data-react-helmet="true" name="description" content="CassKop rack awareness feature helps to spread the Cassandra nodes replicas among different racks in the"><meta data-react-helmet="true" property="og:description" content="CassKop rack awareness feature helps to spread the Cassandra nodes replicas among different racks in the"><meta data-react-helmet="true" property="og:url" content="https://erdrix.github.io/casskop/docs/casskop/2_deployment_configuration/6_cluster_topology">

<link data-react-helmet="true" rel="shortcut icon" href="/casskop/img/casskop.ico">


<link rel="stylesheet" href="/casskop/styles.4bb9a4a4.css">

</head>
<body>
<script>!function(){function t(t){document.documentElement.setAttribute("data-theme",t)}function e(){var t=null;try{t=localStorage.getItem("theme")}catch(t){}return t}var n=window.matchMedia("(prefers-color-scheme: dark)");n.addListener((function(n){null===e()&&t(n.matches?"dark":"")}));var a=e();null!==a?t(a):n.matches&&t("dark")}()</script>
<div id="__docusaurus">
<nav class="navbar navbar--light navbar--fixed-top"><div class="navbar__inner"><div class="navbar__items"><div aria-label="Navigation bar toggle" class="navbar__toggle" role="button" tabindex="0"><svg xmlns="http://www.w3.org/2000/svg" width="30" height="30" viewBox="0 0 30 30" role="img" focusable="false"><title>Menu</title><path stroke="currentColor" stroke-linecap="round" stroke-miterlimit="10" stroke-width="2" d="M4 7h22M4 15h22M4 23h22"></path></svg></div><a aria-current="page" class="navbar__brand active" href="/casskop/"><img class="navbar__logo" src="/casskop/img/casskop_alone.png" alt="Casskop Logo"><strong>Casskop</strong></a><a class="navbar__item navbar__link" href="/casskop/docs/overview">Docs</a><a class="navbar__item navbar__link" href="/casskop/blog">Blog</a></div><div class="navbar__items navbar__items--right"><a class="navbar__item navbar__link" target="_blank" rel="noopener noreferrer" href="https://github.com/Orange-OpenSource/casskop">GitHub</a><div class="react-toggle react-toggle--disabled displayOnlyInLargeViewport_1gtM"><div class="react-toggle-track"><div class="react-toggle-track-check"><span class="toggle_keGJ moon_1gwN"></span></div><div class="react-toggle-track-x"><span class="toggle_keGJ sun_3CPA"></span></div></div><div class="react-toggle-thumb"></div><input type="checkbox" disabled="" aria-label="Dark mode toggle" class="react-toggle-screenreader-only"></div></div></div><div role="presentation" class="navbar-sidebar__backdrop"></div><div class="navbar-sidebar"><div class="navbar-sidebar__brand"><a aria-current="page" class="navbar__brand active" href="/casskop/"><img class="navbar__logo" src="/casskop/img/casskop_alone.png" alt="Casskop Logo"><strong>Casskop</strong></a></div><div class="navbar-sidebar__items"><div class="menu"><ul class="menu__list"><li class="menu__list-item"><a class="menu__link" href="/casskop/docs/overview">Docs</a></li><li class="menu__list-item"><a class="menu__link" href="/casskop/blog">Blog</a></li><li class="menu__list-item"><a class="menu__link" target="_blank" rel="noopener noreferrer" href="https://github.com/Orange-OpenSource/casskop">GitHub</a></li></ul></div></div></div></nav><div class="main-wrapper"><div class="docPage_1kjD"><div class="docSidebarContainer_1cYp"><div class="sidebar_1kLs"><div class="menu menu--responsive"><button aria-label="Open Menu" class="button button--secondary button--sm menu__button" type="button"><svg class="sidebarMenuIcon_2vk4" xmlns="http://www.w3.org/2000/svg" height="24" width="24" viewBox="0 0 32 32" role="img" focusable="false"><title>Menu</title><path stroke="currentColor" stroke-linecap="round" stroke-miterlimit="10" stroke-width="2" d="M4 7h22M4 15h22M4 23h22"></path></svg></button><ul class="menu__list"><li class="menu__list-item menu__list-item--collapsed"><a class="menu__link menu__link--sublist" href="#!">Overview</a><ul class="menu__list"><li class="menu__list-item"><a class="menu__link" href="/casskop/docs/overview">Overview</a></li></ul></li><li class="menu__list-item"><a class="menu__link menu__link--sublist menu__link--active" href="#!">Casskop</a><ul class="menu__list"><li class="menu__list-item menu__list-item--collapsed"><a class="menu__link menu__link--sublist" href="#!">Getting Started</a><ul class="menu__list"><li class="menu__list-item"><a class="menu__link" href="/casskop/docs/casskop/1_getting_started/1_overview">Overview</a></li><li class="menu__list-item"><a class="menu__link" href="/casskop/docs/casskop/1_getting_started/2_Pre-requisites">Pre-requisites</a></li><li class="menu__list-item"><a class="menu__link" href="/casskop/docs/casskop/1_getting_started/3_quickstart">Quickstart</a></li></ul></li><li class="menu__list-item"><a class="menu__link menu__link--sublist menu__link--active" href="#!">Deployment Configuration</a><ul class="menu__list"><li class="menu__list-item"><a class="menu__link" href="/casskop/docs/casskop/2_deployment_configuration/1_cassandra_cluster_config">Cassandra cluster configuration</a></li><li class="menu__list-item"><a class="menu__link" href="/casskop/docs/casskop/2_deployment_configuration/2_cassandra_config">Cassandra configuration</a></li><li class="menu__list-item"><a class="menu__link" href="/casskop/docs/casskop/2_deployment_configuration/3_cassandra_storage">Cassandra storage</a></li><li class="menu__list-item"><a class="menu__link" href="/casskop/docs/casskop/2_deployment_configuration/4_kubernetest_object">Kubernetes objects</a></li><li class="menu__list-item"><a class="menu__link" href="/casskop/docs/casskop/2_deployment_configuration/5_cpu_memory_resources">CPU and memory resources</a></li><li class="menu__list-item"><a aria-current="page" class="menu__link menu__link--active" href="/casskop/docs/casskop/2_deployment_configuration/6_cluster_topology">Cluster topology - Cassandra rack aware deployments</a></li><li class="menu__list-item"><a class="menu__link" href="/casskop/docs/casskop/2_deployment_configuration/7_implementation_architecture">Implementation architecture</a></li><li class="menu__list-item"><a class="menu__link" href="/casskop/docs/casskop/2_deployment_configuration/8_advanced_configuration">Advanced configuration</a></li><li class="menu__list-item"><a class="menu__link" href="/casskop/docs/casskop/2_deployment_configuration/9_cassandra_node_management">Cassandra nodes management</a></li><li class="menu__list-item"><a class="menu__link" href="/casskop/docs/casskop/2_deployment_configuration/10_cassandracluster_status">Cassandra cluster status</a></li><li class="menu__list-item"><a class="menu__link" href="/casskop/docs/casskop/2_deployment_configuration/11_cassandracluster_crd_definition">Cassandra cluster CRD definition</a></li></ul></li><li class="menu__list-item menu__list-item--collapsed"><a class="menu__link menu__link--sublist" href="#!">Operations</a><ul class="menu__list"><li class="menu__list-item"><a class="menu__link" href="/casskop/docs/casskop/3_operations/1_overview">Overview</a></li><li class="menu__list-item"><a class="menu__link" href="/casskop/docs/casskop/3_operations/2_cluster_operations">Cluster operations</a></li><li class="menu__list-item"><a class="menu__link" href="/casskop/docs/casskop/3_operations/3_cassandra_pods_operations">Cluster operations</a></li></ul></li><li class="menu__list-item"><a class="menu__link" href="/casskop/docs/casskop/4_troubleshooting">Troubleshooting</a></li></ul></li><li class="menu__list-item menu__list-item--collapsed"><a class="menu__link menu__link--sublist" href="#!">Multi-Casskop</a><ul class="menu__list"><li class="menu__list-item"><a class="menu__link" href="/casskop/docs/multi-casskop/1_overview">Overview</a></li><li class="menu__list-item"><a class="menu__link" href="/casskop/docs/multi-casskop/2_pre-requisite">Pre-requisite</a></li><li class="menu__list-item"><a class="menu__link" href="/casskop/docs/multi-casskop/3_quickstart">Quickstart</a></li></ul></li><li class="menu__list-item menu__list-item--collapsed"><a class="menu__link menu__link--sublist" href="#!">Contributing</a><ul class="menu__list"><li class="menu__list-item menu__list-item--collapsed"><a class="menu__link menu__link--sublist" href="#!">Development</a><ul class="menu__list"><li class="menu__list-item"><a class="menu__link" href="/casskop/docs/contributing/1_development/1_circle_ci_build_pipeline">CircleCI build pipeline</a></li><li class="menu__list-item"><a class="menu__link" href="/casskop/docs/contributing/1_development/2_operator_sdk">Operator SDK</a></li></ul></li><li class="menu__list-item menu__list-item--collapsed"><a class="menu__link menu__link--sublist" href="#!">Release the project</a><ul class="menu__list"><li class="menu__list-item"><a class="menu__link" href="/casskop/docs/contributing/2_release_project/1_tasks">Tasks</a></li><li class="menu__list-item"><a class="menu__link" href="/casskop/docs/contributing/2_release_project/2_with_helm">With Helm</a></li><li class="menu__list-item"><a class="menu__link" href="/casskop/docs/contributing/2_release_project/3_with_olm">With OLM</a></li></ul></li><li class="menu__list-item"><a class="menu__link" href="/casskop/docs/contributing/3_reporting_bugs">Reporting bugs</a></li><li class="menu__list-item menu__list-item--collapsed"><a class="menu__link menu__link--sublist" href="#!">How this repository was initially build</a><ul class="menu__list"><li class="menu__list-item"><a class="menu__link" href="/casskop/docs/contributing/4_initial_build/1_boilerplate_casskop">Boilerplate CassKop</a></li><li class="menu__list-item"><a class="menu__link" href="/casskop/docs/contributing/4_initial_build/2_infos_developer">Useful Infos for developers</a></li></ul></li></ul></li></ul></div></div></div><main class="docMainContainer_FFX1"><div class="padding-vert--lg"><div class="container"><div class="row"><div class="col"><div class="docItemContainer_2cwg"><article><header><h1 class="docTitle_1vWb">Cluster topology - Cassandra rack aware deployments</h1></header><div class="markdown"><p>CassKop rack awareness feature helps to spread the Cassandra nodes replicas among different racks in the
kubernetes infrastructure. Enabling rack awareness helps to improve availability of Cassandra nodes and the data they
are hosting, through correct use of Cassandra&#x27;s replication factor. </p><blockquote><p><strong>Note:</strong> Rack might represent an availability zone, data center or an actual physical rack in your data center.</p></blockquote><h2><a aria-hidden="true" tabindex="-1" class="anchor" id="quick-overview"></a><a aria-hidden="true" tabindex="-1" class="hash-link" href="#quick-overview" title="Direct link to heading">#</a>Quick overview</h2><p>CassKop awareness can be configured in the <code>CassandraCluster.spec.topology</code> section. </p><p>If the <code>topology</code> section is missing then CassKop will create a default Cassandra DC <code>dc1</code> and a default Rack
<code>rack1</code>.
In this case, CassKop will not use specific kubernetes nodes labels for placement and in consequence the cluster is
not rack aware. </p><p>In the <code>topology</code> section we can declare all the Cassandra Datacenters (DCs) and Racks, and for each of them we provide
labels which will need to match the labels assigned to the Kubernetes cluster nodes. </p><p>Each of our rack targets Kubernetes nodes having the combination of labels defined in the <code>dc</code> section and in the <code>rack</code>
section. The labels are used in Kubernetes when scheduling the Cassandra pods to kubernetes nodes.
This has the effect of spreading the Cassandra nodes across physical zones.</p><blockquote><p><strong>IMPORTANT:</strong> CassKop doesn&#x27;t rely on specific labels and will adapt to any topology you may define in your
datacenter or cloud provider. </p></blockquote><h2><a aria-hidden="true" tabindex="-1" class="anchor" id="kubernetes-nodes-labels"></a><a aria-hidden="true" tabindex="-1" class="hash-link" href="#kubernetes-nodes-labels" title="Direct link to heading">#</a>Kubernetes nodes labels</h2><p>Cassandra will run on Kubernetes Nodes, which may already have some labels representing their geographic topology.</p><p>Example :</p><p><img src="../docs/assets/kubernetes-operators/topology-custom-example.png"></p><p>Example of labels for node001 in our dc:</p><pre class="mdxCodeBlock_iHAB"><div class="codeBlockWrapper_2av3"><pre class="prism-code language-yaml codeBlock_2GNs" style="color:#bfc7d5;background-color:#292d3e"><div class="token-line" style="color:#bfc7d5"><span class="token plain">location.myorg.com/bay=1</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">location.myorg.com/building=building</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">location.myorg.com/label=SC_K08_</span><span class="token punctuation" style="color:rgb(199, 146, 234)">-</span><span class="token plain">_KUBERNETES</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">location.myorg.com/room=Salle_1</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">location.myorg.com/site=SiteName</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">location.myorg.com/street=Rue_3</span></div></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_1Zmi">Copy</button></div></pre><p>In the cloud the labels used for topology may better look like :</p><p><img src="../docs/assets/kubernetes-operators/topology-custom-example.png"></p><pre class="mdxCodeBlock_iHAB"><div class="codeBlockWrapper_2av3"><pre class="prism-code language-yaml codeBlock_2GNs" style="color:#bfc7d5;background-color:#292d3e"><div class="token-line" style="color:#bfc7d5"><span class="token plain">beta.kubernetes.io/fluentd</span><span class="token punctuation" style="color:rgb(199, 146, 234)">-</span><span class="token plain">ds</span><span class="token punctuation" style="color:rgb(199, 146, 234)">-</span><span class="token plain">ready=true</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">failure</span><span class="token punctuation" style="color:rgb(199, 146, 234)">-</span><span class="token plain">domain.beta.kubernetes.io/region=europe</span><span class="token punctuation" style="color:rgb(199, 146, 234)">-</span><span class="token plain">west1</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">kubernetes.io/hostname=gke</span><span class="token punctuation" style="color:rgb(199, 146, 234)">-</span><span class="token plain">demo</span><span class="token punctuation" style="color:rgb(199, 146, 234)">-</span><span class="token plain">default</span><span class="token punctuation" style="color:rgb(199, 146, 234)">-</span><span class="token plain">pool</span><span class="token punctuation" style="color:rgb(199, 146, 234)">-</span><span class="token plain">0c404f82</span><span class="token punctuation" style="color:rgb(199, 146, 234)">-</span><span class="token number" style="color:rgb(247, 140, 108)">0100</span><span class="token plain"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">beta.kubernetes.io/arch=amd64</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">failure</span><span class="token punctuation" style="color:rgb(199, 146, 234)">-</span><span class="token plain">domain.beta.kubernetes.io/zone=europe</span><span class="token punctuation" style="color:rgb(199, 146, 234)">-</span><span class="token plain">west1</span><span class="token punctuation" style="color:rgb(199, 146, 234)">-</span><span class="token plain">d</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">beta.kubernetes.io/os=linux</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">cloud.google.com/gke</span><span class="token punctuation" style="color:rgb(199, 146, 234)">-</span><span class="token plain">os</span><span class="token punctuation" style="color:rgb(199, 146, 234)">-</span><span class="token plain">distribution=cos</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">beta.kubernetes.io/instance</span><span class="token punctuation" style="color:rgb(199, 146, 234)">-</span><span class="token plain">type=n1</span><span class="token punctuation" style="color:rgb(199, 146, 234)">-</span><span class="token plain">standard</span><span class="token punctuation" style="color:rgb(199, 146, 234)">-</span><span class="token number" style="color:rgb(247, 140, 108)">4</span><span class="token plain"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">cloud.google.com/gke</span><span class="token punctuation" style="color:rgb(199, 146, 234)">-</span><span class="token plain">nodepool=default</span><span class="token punctuation" style="color:rgb(199, 146, 234)">-</span><span class="token plain">pool</span></div></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_1Zmi">Copy</button></div></pre><p>The idea is to use the Kubernetes nodes labels which refer to their physical position in the datacenters, to allow or
not Cassandra Pods placement.</p><p>Because CassKop manages its Cassandra Node Pods through
<a href="https://kubernetes.io/docs/concepts/workloads/controllers/statefulset/">statefulset</a>,
each Pod will inherit the placement configuration of its parent
statefulset. In order to place Pods on different racks, we need to associate a new statefulset with specialized nodes
placement constraints for each Cassandra Rack we define.</p><blockquote><p>Because the AZ feature was not yet available for statefulsets when we began to develop CassKop, we chose to
implement 1 statefulset for 1 Cassandra Rack. Hopefully, we will be able to benefit of improvements about the
topology-aware dynamic provisioning feature proposed in futur version of K8S (more informations here :
<a href="https://kubernetes.io/blog/2018/10/11/topology-aware-volume-provisioning-in-kubernetes/">https://kubernetes.io/blog/2018/10/11/topology-aware-volume-provisioning-in-kubernetes/</a>
)</p></blockquote><p>See Example of configuration with topology : <a href="samples/cassandracluster-demo-gke.yaml">cassandracluster-demo-gke.yaml</a></p><h2><a aria-hidden="true" tabindex="-1" class="anchor" id="configuring-pod-scheduling"></a><a aria-hidden="true" tabindex="-1" class="hash-link" href="#configuring-pod-scheduling" title="Direct link to heading">#</a>Configuring pod scheduling</h2><p>When two applications are scheduled to the same Kubernetes node, both applications might use the same resources like
disk I/O and impact performances. It may be recommended to schedule Cassandra Pods in a way that avoids sharing nodes
with other critical workloads. Using the right nodes or dedicated a set of nodes only for cassandra are the best ways to
avoid such problems.</p><p><a href="https://kubernetes.io/docs/concepts/configuration/assign-pod-node/">Placement of Pods</a> in a Statefulsets are done
using <strong>NodeAffinity</strong> and <strong>PodAntiAffinity</strong> : </p><ul><li><a href="https://kubernetes.io/docs/concepts/configuration/assign-pod-node/">nodeAffinity</a> will be used to select specific
nodes which have specific targeted labels.</li><li><a href="https://kubernetes.io/docs/concepts/configuration/assign-pod-node/#affinity-and-anti-affinity">podAntiAffinity</a> can
be used to ensure that critical applications are never scheduled on the same node.</li></ul><h3><a aria-hidden="true" tabindex="-1" class="anchor" id="cassandra-node-placement-in-the-kubernetes-cluster"></a><a aria-hidden="true" tabindex="-1" class="hash-link" href="#cassandra-node-placement-in-the-kubernetes-cluster" title="Direct link to heading">#</a>Cassandra node placement in the Kubernetes cluster</h3><h4><a aria-hidden="true" tabindex="-1" class="anchor" id="node-affinity"></a><a aria-hidden="true" tabindex="-1" class="hash-link" href="#node-affinity" title="Direct link to heading">#</a>Node affinity</h4><p>To target a Specific Kubernetes group of Nodes CassKop needs to define a specific <strong>nodeAffinity</strong>
section in the targeted <code>dc-rack</code> statefulset to match specific kubernetes nodes labels.</p><p>Example. If we want to deploy our statefulset only on nodes which have theses labels :</p><pre class="mdxCodeBlock_iHAB"><div class="codeBlockWrapper_2av3"><pre class="prism-code language-yaml codeBlock_2GNs" style="color:#bfc7d5;background-color:#292d3e"><div class="token-line" style="color:#bfc7d5"><span class="token plain">location.myorg.com/site=Valbonne</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">location.myorg.com/building=HT2</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">location.myorg.com/room=Salle_1</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">location.myorg.com/street=Rue_11</span></div></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_1Zmi">Copy</button></div></pre><p>CassKop need to add this section in the Statefulset definition :</p><pre class="mdxCodeBlock_iHAB"><div class="codeBlockWrapper_2av3"><pre class="prism-code language-yaml codeBlock_2GNs" style="color:#bfc7d5;background-color:#292d3e"><div class="token-line" style="color:#bfc7d5"><span class="token key atrule">affinity</span><span class="token punctuation" style="color:rgb(199, 146, 234)">:</span><span class="token plain"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    </span><span class="token key atrule">nodeAffinity</span><span class="token punctuation" style="color:rgb(199, 146, 234)">:</span><span class="token plain"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">      </span><span class="token key atrule">requiredDuringSchedulingIgnoredDuringExecution</span><span class="token punctuation" style="color:rgb(199, 146, 234)">:</span><span class="token plain"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">        </span><span class="token key atrule">nodeSelectorTerms</span><span class="token punctuation" style="color:rgb(199, 146, 234)">:</span><span class="token plain"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">          </span><span class="token punctuation" style="color:rgb(199, 146, 234)">-</span><span class="token plain"> </span><span class="token key atrule">key</span><span class="token punctuation" style="color:rgb(199, 146, 234)">:</span><span class="token plain"> location.myorg.com/building</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">            </span><span class="token key atrule">operator</span><span class="token punctuation" style="color:rgb(199, 146, 234)">:</span><span class="token plain"> In</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">            </span><span class="token key atrule">values</span><span class="token punctuation" style="color:rgb(199, 146, 234)">:</span><span class="token plain"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">            </span><span class="token punctuation" style="color:rgb(199, 146, 234)">-</span><span class="token plain"> HT2</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">          </span><span class="token punctuation" style="color:rgb(199, 146, 234)">-</span><span class="token plain"> </span><span class="token key atrule">key</span><span class="token punctuation" style="color:rgb(199, 146, 234)">:</span><span class="token plain"> location.myorg.com/room</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">            </span><span class="token key atrule">operator</span><span class="token punctuation" style="color:rgb(199, 146, 234)">:</span><span class="token plain"> In</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">            </span><span class="token key atrule">values</span><span class="token punctuation" style="color:rgb(199, 146, 234)">:</span><span class="token plain"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">            </span><span class="token punctuation" style="color:rgb(199, 146, 234)">-</span><span class="token plain"> Salle_1</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">          </span><span class="token punctuation" style="color:rgb(199, 146, 234)">-</span><span class="token plain"> </span><span class="token key atrule">key</span><span class="token punctuation" style="color:rgb(199, 146, 234)">:</span><span class="token plain"> location.myorg.com/site</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">            </span><span class="token key atrule">operator</span><span class="token punctuation" style="color:rgb(199, 146, 234)">:</span><span class="token plain"> In</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">            </span><span class="token key atrule">values</span><span class="token punctuation" style="color:rgb(199, 146, 234)">:</span><span class="token plain"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">            </span><span class="token punctuation" style="color:rgb(199, 146, 234)">-</span><span class="token plain"> Valbonne</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">          </span><span class="token punctuation" style="color:rgb(199, 146, 234)">-</span><span class="token plain"> </span><span class="token key atrule">key</span><span class="token punctuation" style="color:rgb(199, 146, 234)">:</span><span class="token plain"> location.myorg.com/street</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">            </span><span class="token key atrule">operator</span><span class="token punctuation" style="color:rgb(199, 146, 234)">:</span><span class="token plain"> In</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">            </span><span class="token key atrule">values</span><span class="token punctuation" style="color:rgb(199, 146, 234)">:</span><span class="token plain"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">            </span><span class="token punctuation" style="color:rgb(199, 146, 234)">-</span><span class="token plain"> Rue_9</span></div></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_1Zmi">Copy</button></div></pre><p>All Pods that will be created from this statefulset will target only nodes which have theses 4 labels.
If there is no kubernetes nodes available with theses labels, then the statefulset will remain stuck in a pending state,
until we correct either labels on nodes, or deployment constraints definition of the statefulset. </p><p>We can also use specific labels to dedicate some kubernetes nodes to some type of work, for instance dedicated some
nodes for Cassandra. </p><p>You can define custom labels on kubernetes nodes :</p><pre class="mdxCodeBlock_iHAB"><div class="codeBlockWrapper_2av3"><pre class="prism-code language-sh codeBlock_2GNs" style="color:#bfc7d5;background-color:#292d3e"><div class="token-line" style="color:#bfc7d5"><span class="token plain">kubectl label node &lt;your-node&gt; &lt;label-name&gt;=&lt;label-value&gt;</span></div></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_1Zmi">Copy</button></div></pre><blockquote><p>This is done automatically by combining the labels you specify in the Cassandra CRD definition in the <code>Topology</code>
section. </p></blockquote><h4><a aria-hidden="true" tabindex="-1" class="anchor" id="pod-anti-affinity"></a><a aria-hidden="true" tabindex="-1" class="hash-link" href="#pod-anti-affinity" title="Direct link to heading">#</a>Pod anti affinity</h4><p>If we loose a Kubernetes node, then we may want to limit the impact to loosing only one Cassandra node. Otherwise,
depending on the replication factor, we may have a data loss. </p><p>In our CassandraCluster, the statefulset will target a pool of Kubernetes nodes using it&#x27;s NodeSelector we just saw
above.
All theses Pods will inherit the specific labels from the Statefulset. </p><p>To implement the limitation &quot;one Cassandra Pod per Kubernetes node&quot;, we use the pod definition section
<code>podAntiAffinity</code>. This tells kubernetes that it can&#x27;t deploy to a Kubernetes node, if a pod having the same labels
already exists. </p><pre class="mdxCodeBlock_iHAB"><div class="codeBlockWrapper_2av3"><pre class="prism-code language-yaml codeBlock_2GNs" style="color:#bfc7d5;background-color:#292d3e"><div class="token-line" style="color:#bfc7d5"><span class="token key atrule">podAntiAffinity</span><span class="token punctuation" style="color:rgb(199, 146, 234)">:</span><span class="token plain"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">      </span><span class="token key atrule">requiredDuringSchedulingIgnoredDuringExecution</span><span class="token punctuation" style="color:rgb(199, 146, 234)">:</span><span class="token plain"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">      </span><span class="token punctuation" style="color:rgb(199, 146, 234)">-</span><span class="token plain"> </span><span class="token key atrule">podAffinityTerm</span><span class="token punctuation" style="color:rgb(199, 146, 234)">:</span><span class="token plain"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">          </span><span class="token key atrule">labelSelector</span><span class="token punctuation" style="color:rgb(199, 146, 234)">:</span><span class="token plain"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">            </span><span class="token key atrule">matchLabels</span><span class="token punctuation" style="color:rgb(199, 146, 234)">:</span><span class="token plain"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">              </span><span class="token key atrule">app</span><span class="token punctuation" style="color:rgb(199, 146, 234)">:</span><span class="token plain"> cassandracluster</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">              </span><span class="token key atrule">cassandracluster</span><span class="token punctuation" style="color:rgb(199, 146, 234)">:</span><span class="token plain"> cassandra</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">              </span><span class="token key atrule">cluster</span><span class="token punctuation" style="color:rgb(199, 146, 234)">:</span><span class="token plain"> k8s.kaas</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">          </span><span class="token key atrule">topologyKey</span><span class="token punctuation" style="color:rgb(199, 146, 234)">:</span><span class="token plain"> kubernetes.io/hostname</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">        </span><span class="token key atrule">weight</span><span class="token punctuation" style="color:rgb(199, 146, 234)">:</span><span class="token plain"> </span><span class="token number" style="color:rgb(247, 140, 108)">100</span></div></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_1Zmi">Copy</button></div></pre><p>This Tells that we <strong>Require</strong> not deploy to a node if a pod already exists with theses existing labels. </p><blockquote><p>This is configured by default by CassKop</p></blockquote><h4><a aria-hidden="true" tabindex="-1" class="anchor" id="using-dedicated-nodes"></a><a aria-hidden="true" tabindex="-1" class="hash-link" href="#using-dedicated-nodes" title="Direct link to heading">#</a>Using dedicated nodes</h4><p>Cluster administrators can mark selected kubernetes nodes as tainted. Nodes with taints are excluded from regular
scheduling and normal pods will not be scheduled to run on them. Only services which can tolerate the taint set on the
node can be scheduled on it. The only other services running on such nodes will be kubernetes system services such  as
log collectors or software  defined networks</p><p>Taints can be used to create dedicated nodes. Running Cassandra on dedicated nodes can have many advantages. There will
be no other applications running on the same nodes which could cause disturbance or consume the resources needed  for
Cassandra. That can lead to improved performance and stability.</p><p>Example of tainting a node :</p><pre class="mdxCodeBlock_iHAB"><div class="codeBlockWrapper_2av3"><pre class="prism-code language-sh codeBlock_2GNs" style="color:#bfc7d5;background-color:#292d3e"><div class="token-line" style="color:#bfc7d5"><span class="token plain">kubectl taint node &lt;your-node&gt; dedicated=Cassandra:NoSchedule</span></div></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_1Zmi">Copy</button></div></pre><p>Additionally, add a label to the selected nodes as well</p><pre class="mdxCodeBlock_iHAB"><div class="codeBlockWrapper_2av3"><pre class="prism-code language-sh codeBlock_2GNs" style="color:#bfc7d5;background-color:#292d3e"><div class="token-line" style="color:#bfc7d5"><span class="token plain">kubectl label node &lt;your-node&gt; dedicated=Cassandra</span></div></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_1Zmi">Copy</button></div></pre><p>The <code>toleration</code> must be applied on the statefulset at the same level as <code>affinity</code>.</p><pre class="mdxCodeBlock_iHAB"><div class="codeBlockWrapper_2av3"><pre class="prism-code language-yaml codeBlock_2GNs" style="color:#bfc7d5;background-color:#292d3e"><div class="token-line" style="color:#bfc7d5"><span class="token punctuation" style="color:rgb(199, 146, 234)">...</span><span class="token plain"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    </span><span class="token key atrule">tolerations</span><span class="token punctuation" style="color:rgb(199, 146, 234)">:</span><span class="token plain"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">      </span><span class="token punctuation" style="color:rgb(199, 146, 234)">-</span><span class="token plain"> </span><span class="token key atrule">key</span><span class="token punctuation" style="color:rgb(199, 146, 234)">:</span><span class="token plain"> </span><span class="token string" style="color:rgb(195, 232, 141)">&quot;dedicated&quot;</span><span class="token plain"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">        </span><span class="token key atrule">operator</span><span class="token punctuation" style="color:rgb(199, 146, 234)">:</span><span class="token plain"> </span><span class="token string" style="color:rgb(195, 232, 141)">&quot;Equal&quot;</span><span class="token plain"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">        </span><span class="token key atrule">value</span><span class="token punctuation" style="color:rgb(199, 146, 234)">:</span><span class="token plain"> </span><span class="token string" style="color:rgb(195, 232, 141)">&quot;Cassandra&quot;</span><span class="token plain"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">        </span><span class="token key atrule">effect</span><span class="token punctuation" style="color:rgb(199, 146, 234)">:</span><span class="token plain"> </span><span class="token string" style="color:rgb(195, 232, 141)">&quot;NoSchedule&quot;</span><span class="token plain"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain"></span><span class="token punctuation" style="color:rgb(199, 146, 234)">...</span></div></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_1Zmi">Copy</button></div></pre><blockquote><p><strong>IMPORTANT:</strong> toleration must be used with node affinity on the same labels
TODO: actually the toleration is not implemented in CassKop</p></blockquote><h3><a aria-hidden="true" tabindex="-1" class="anchor" id="configuring-hard-antiaffinity-in-cassandra-cluster"></a><a aria-hidden="true" tabindex="-1" class="hash-link" href="#configuring-hard-antiaffinity-in-cassandra-cluster" title="Direct link to heading">#</a>Configuring hard antiAffinity in Cassandra cluster</h3><p>In development environment, we may have other concern than in production and we may allow our cluster to deploy several
nodes on the same kubernetes nodes.</p><p>The boolean <code>hardAntiAffinity</code> parameter in <code>CassandraCluster.spec</code> will define if we want the constraint to be
<strong>Required</strong> or <strong>Preferred</strong></p><p>If <code>hardAntiAffinity=false</code> then the podAntiAffinity will be <strong>preferred</strong> instead of <strong>required</strong> and then kubernetes
will try to not put the cassandra node on the kubernetes node <strong>BUT</strong> it will allow to do it if it has no other choices.</p><h2><a aria-hidden="true" tabindex="-1" class="anchor" id="cassandra-notion-of-dc-and-racks"></a><a aria-hidden="true" tabindex="-1" class="hash-link" href="#cassandra-notion-of-dc-and-racks" title="Direct link to heading">#</a>Cassandra notion of dc and racks</h2><p>As we previously see, the Cassandra rack awareness is defined using several Cassandra datacenters <code>dc</code>s and <code>rack</code>s.
The <code>CassandraCluster.spec.topology</code> section allows us to define the virtual notion of DC &amp; Rack.
For each we will define Kubernetes <code>labels</code> that will be used for pod placement.</p><blockquote><p>The name and numbers of labels used to define a DC &amp; rack is not defined in advance and will be defined in each
CassandraCluster manifests, depending on labels presents on Kubernetes Nodes and the required topology</p></blockquote><h2><a aria-hidden="true" tabindex="-1" class="anchor" id="configure-the-cassandracluster-crd-for-dc--rack"></a><a aria-hidden="true" tabindex="-1" class="hash-link" href="#configure-the-cassandracluster-crd-for-dc--rack" title="Direct link to heading">#</a>Configure the CassandraCluster CRD for dc &amp; rack</h2><p>If the section topology is missing: </p><ul><li>then CassKop will deploy without label constraints to any available kubernetes nodes in the cluster</li><li>there will be only one DC defined named by default <strong>dc1</strong></li><li>there will be only one Rack defined named by default <strong>rack1</strong></li></ul><p>If the <strong>topology</strong> section is defined, this will enable to create specific Cassandra dcs and racks: this creates a
specific statefulset for each rack and deploys on Kubernetes nodes matching the desired Node Labels (the concatenation
of DC labels + Rack labels for each statefulset)</p><p>Example of topology section:</p><pre class="mdxCodeBlock_iHAB"><div class="codeBlockWrapper_2av3"><pre class="prism-code language-yaml codeBlock_2GNs" style="color:#bfc7d5;background-color:#292d3e"><div class="token-line" style="color:#bfc7d5"><span class="token punctuation" style="color:rgb(199, 146, 234)">...</span><span class="token plain"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">  </span><span class="token key atrule">nodesPerRacks</span><span class="token punctuation" style="color:rgb(199, 146, 234)">:</span><span class="token plain"> </span><span class="token number" style="color:rgb(247, 140, 108)">3</span><span class="token plain"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain"></span><span class="token punctuation" style="color:rgb(199, 146, 234)">...</span><span class="token plain"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">  </span><span class="token key atrule">topology</span><span class="token punctuation" style="color:rgb(199, 146, 234)">:</span><span class="token plain"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    </span><span class="token key atrule">dc</span><span class="token punctuation" style="color:rgb(199, 146, 234)">:</span><span class="token plain"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">      </span><span class="token punctuation" style="color:rgb(199, 146, 234)">-</span><span class="token plain"> </span><span class="token key atrule">name</span><span class="token punctuation" style="color:rgb(199, 146, 234)">:</span><span class="token plain"> dc1</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">        </span><span class="token key atrule">labels</span><span class="token punctuation" style="color:rgb(199, 146, 234)">:</span><span class="token plain"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">          </span><span class="token key atrule">location.k8s.myorg.com/site</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(199, 146, 234)">:</span><span class="token plain"> Valbonne</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">          </span><span class="token key atrule">location.k8s.myorg.com/building</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(199, 146, 234)">:</span><span class="token plain"> HT2</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">        </span><span class="token key atrule">rack</span><span class="token punctuation" style="color:rgb(199, 146, 234)">:</span><span class="token plain"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">          </span><span class="token punctuation" style="color:rgb(199, 146, 234)">-</span><span class="token plain"> </span><span class="token key atrule">name</span><span class="token punctuation" style="color:rgb(199, 146, 234)">:</span><span class="token plain"> rack1</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">            </span><span class="token key atrule">labels</span><span class="token punctuation" style="color:rgb(199, 146, 234)">:</span><span class="token plain"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">              </span><span class="token key atrule">location.k8s.myorg.com/room</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(199, 146, 234)">:</span><span class="token plain"> Salle_1</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">              </span><span class="token key atrule">location.k8s.myorg.com/street</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(199, 146, 234)">:</span><span class="token plain"> Rue_9</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">          </span><span class="token punctuation" style="color:rgb(199, 146, 234)">-</span><span class="token plain"> </span><span class="token key atrule">name</span><span class="token punctuation" style="color:rgb(199, 146, 234)">:</span><span class="token plain"> rack2</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">            </span><span class="token key atrule">labels</span><span class="token punctuation" style="color:rgb(199, 146, 234)">:</span><span class="token plain"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">              </span><span class="token key atrule">location.k8s.myorg.com/room</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(199, 146, 234)">:</span><span class="token plain"> Salle_1</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">              </span><span class="token key atrule">location.k8s.myorg.com/street</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(199, 146, 234)">:</span><span class="token plain"> Rue_10</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">      </span><span class="token punctuation" style="color:rgb(199, 146, 234)">-</span><span class="token plain"> </span><span class="token key atrule">name</span><span class="token punctuation" style="color:rgb(199, 146, 234)">:</span><span class="token plain"> dc2</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">        </span><span class="token key atrule">nodesPerRacks</span><span class="token punctuation" style="color:rgb(199, 146, 234)">:</span><span class="token plain"> </span><span class="token number" style="color:rgb(247, 140, 108)">4</span><span class="token plain"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">        </span><span class="token key atrule">labels</span><span class="token punctuation" style="color:rgb(199, 146, 234)">:</span><span class="token plain"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">          </span><span class="token key atrule">location.k8s.myorg.com/site</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(199, 146, 234)">:</span><span class="token plain"> Valbonne</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">          </span><span class="token key atrule">location.k8s.myorg.com/building</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(199, 146, 234)">:</span><span class="token plain"> HT2</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">        </span><span class="token key atrule">rack</span><span class="token punctuation" style="color:rgb(199, 146, 234)">:</span><span class="token plain"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">          </span><span class="token punctuation" style="color:rgb(199, 146, 234)">-</span><span class="token plain"> </span><span class="token key atrule">name</span><span class="token punctuation" style="color:rgb(199, 146, 234)">:</span><span class="token plain"> rack1</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">            </span><span class="token key atrule">labels</span><span class="token punctuation" style="color:rgb(199, 146, 234)">:</span><span class="token plain"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">              </span><span class="token key atrule">location.k8s.myorg.com/room</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(199, 146, 234)">:</span><span class="token plain"> Salle_1</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">              </span><span class="token key atrule">location.k8s.myorg.com/street</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(199, 146, 234)">:</span><span class="token plain"> Rue_11</span></div></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_1Zmi">Copy</button></div></pre><ul><li>This will create 2 Cassandra DC (<code>dc1</code> &amp; <code>dc2</code>)<ul><li>For DC <code>dc1</code> it will create 2 Racks : <code>rack1</code> and <code>rack2</code><ul><li>In each of theses Racks there will be 3 Cassandra nodes</li><li>The <code>dc1</code> will have 6 nodes</li></ul></li><li>For DC <code>dc2</code> it will create 1 Rack : <code>rack1</code><ul><li>the <code>dc2</code> overwrite the global parameter <code>nodesPerRacks=3</code> with a value of <code>4</code>. </li><li>The <code>dc2</code> will have 4 nodes</li></ul></li></ul></li></ul><blockquote><p><strong>Important:</strong> We want to have the same numbers of Cassandra nodes in each Racks for a dedicated
Datacenter. We can still have different values for different datacenters. </p></blockquote><p>The NodeSelectors labels for each Rack will be the aggregation of labels of the DC and the labels for the Racks :</p><p>For instance with this example, NodeSelectors labels for <code>dc1</code> / <code>rack2</code> will be :</p><pre class="mdxCodeBlock_iHAB"><div class="codeBlockWrapper_2av3"><pre class="prism-code language-yaml codeBlock_2GNs" style="color:#bfc7d5;background-color:#292d3e"><div class="token-line" style="color:#bfc7d5"><span class="token key atrule">location.k8s.myorg.com/site</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(199, 146, 234)">:</span><span class="token plain"> Valbonne</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain"></span><span class="token key atrule">location.k8s.myorg.com/building</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(199, 146, 234)">:</span><span class="token plain"> HT2</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain"></span><span class="token key atrule">location.k8s.myorg.com/room</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(199, 146, 234)">:</span><span class="token plain"> Salle_1</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain"></span><span class="token key atrule">location.k8s.myorg.com/street</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(199, 146, 234)">:</span><span class="token plain"> Rue_10</span></div></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_1Zmi">Copy</button></div></pre><blockquote><p>The <code>dc</code> / <code>rack</code> topology definition is generic and does not rely on particular labels. It uses the ones
corresponding to your needs.</p></blockquote><blockquote><p><strong>Note:</strong> The names for the dc and rack must be lowercase and respect Kubernetes DNS naming which follow <a href="http://tools.ietf.org/html/rfc1123#section-2">RFC 1123
definition</a> which can be expressed with this regular expression :
<code>[a-z0-9]([-a-z0-9]*[a-z0-9])?</code></p></blockquote><h3><a aria-hidden="true" tabindex="-1" class="anchor" id="how-casskop-configures-dc-and-rack-in-cassandra"></a><a aria-hidden="true" tabindex="-1" class="hash-link" href="#how-casskop-configures-dc-and-rack-in-cassandra" title="Direct link to heading">#</a>How CassKop configures dc and rack in Cassandra</h3><p>CassKop will add 2 specific labels on each created Pod to tell them in witch Cassandra DC and Rack they belong :</p><p>Example :</p><pre class="mdxCodeBlock_iHAB"><div class="codeBlockWrapper_2av3"><pre class="prism-code language-yaml codeBlock_2GNs" style="color:#bfc7d5;background-color:#292d3e"><div class="token-line" style="color:#bfc7d5"><span class="token plain">cassandraclusters.db.orange.com.dc=dc1</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">cassandraclusters.db.orange.com.rack=rack1</span></div></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_1Zmi">Copy</button></div></pre><p>Using the Kubernetes DownwardAPI, CassKop will inject into the Cassandra Image 2 environment variables, from theses
2 labels. Excerpt from the Statefulset template :</p><pre class="mdxCodeBlock_iHAB"><div class="codeBlockWrapper_2av3"><pre class="prism-code language-yaml codeBlock_2GNs" style="color:#bfc7d5;background-color:#292d3e"><div class="token-line" style="color:#bfc7d5"><span class="token punctuation" style="color:rgb(199, 146, 234)">...</span><span class="token plain"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">v1.EnvVar</span><span class="token punctuation" style="color:rgb(199, 146, 234)">{</span><span class="token plain"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    </span><span class="token key atrule">Name</span><span class="token punctuation" style="color:rgb(199, 146, 234)">:</span><span class="token plain"> </span><span class="token string" style="color:rgb(195, 232, 141)">&quot;CASSANDRA_DC&quot;</span><span class="token punctuation" style="color:rgb(199, 146, 234)">,</span><span class="token plain"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    </span><span class="token key atrule">ValueFrom</span><span class="token punctuation" style="color:rgb(199, 146, 234)">:</span><span class="token plain"> </span><span class="token important">&amp;v1</span><span class="token plain">.EnvVarSource</span><span class="token punctuation" style="color:rgb(199, 146, 234)">{</span><span class="token plain"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">        </span><span class="token key atrule">FieldRef</span><span class="token punctuation" style="color:rgb(199, 146, 234)">:</span><span class="token plain"> </span><span class="token important">&amp;v1</span><span class="token plain">.ObjectFieldSelector</span><span class="token punctuation" style="color:rgb(199, 146, 234)">{</span><span class="token plain"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">            </span><span class="token key atrule">FieldPath</span><span class="token punctuation" style="color:rgb(199, 146, 234)">:</span><span class="token plain"> </span><span class="token string" style="color:rgb(195, 232, 141)">&quot;metadata.labels[&#x27;cassandraclusters.db.orange.com.dc&#x27;]&quot;</span><span class="token punctuation" style="color:rgb(199, 146, 234)">,</span><span class="token plain"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">        </span><span class="token punctuation" style="color:rgb(199, 146, 234)">}</span><span class="token punctuation" style="color:rgb(199, 146, 234)">,</span><span class="token plain"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    </span><span class="token punctuation" style="color:rgb(199, 146, 234)">}</span><span class="token punctuation" style="color:rgb(199, 146, 234)">,</span><span class="token plain"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain"></span><span class="token punctuation" style="color:rgb(199, 146, 234)">}</span><span class="token punctuation" style="color:rgb(199, 146, 234)">,</span><span class="token plain"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">v1.EnvVar</span><span class="token punctuation" style="color:rgb(199, 146, 234)">{</span><span class="token plain"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    </span><span class="token key atrule">Name</span><span class="token punctuation" style="color:rgb(199, 146, 234)">:</span><span class="token plain"> </span><span class="token string" style="color:rgb(195, 232, 141)">&quot;CASSANDRA_RACK&quot;</span><span class="token punctuation" style="color:rgb(199, 146, 234)">,</span><span class="token plain"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    </span><span class="token key atrule">ValueFrom</span><span class="token punctuation" style="color:rgb(199, 146, 234)">:</span><span class="token plain"> </span><span class="token important">&amp;v1</span><span class="token plain">.EnvVarSource</span><span class="token punctuation" style="color:rgb(199, 146, 234)">{</span><span class="token plain"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">        </span><span class="token key atrule">FieldRef</span><span class="token punctuation" style="color:rgb(199, 146, 234)">:</span><span class="token plain"> </span><span class="token important">&amp;v1</span><span class="token plain">.ObjectFieldSelector</span><span class="token punctuation" style="color:rgb(199, 146, 234)">{</span><span class="token plain"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">            </span><span class="token key atrule">FieldPath</span><span class="token punctuation" style="color:rgb(199, 146, 234)">:</span><span class="token plain"> </span><span class="token string" style="color:rgb(195, 232, 141)">&quot;metadata.labels[&#x27;cassandraclusters.db.orange.com.rack&#x27;]&quot;</span><span class="token punctuation" style="color:rgb(199, 146, 234)">,</span><span class="token plain"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">        </span><span class="token punctuation" style="color:rgb(199, 146, 234)">}</span><span class="token punctuation" style="color:rgb(199, 146, 234)">,</span><span class="token plain"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    </span><span class="token punctuation" style="color:rgb(199, 146, 234)">}</span><span class="token punctuation" style="color:rgb(199, 146, 234)">,</span><span class="token plain"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain"></span><span class="token punctuation" style="color:rgb(199, 146, 234)">}</span><span class="token punctuation" style="color:rgb(199, 146, 234)">,</span><span class="token plain"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain"></span><span class="token punctuation" style="color:rgb(199, 146, 234)">...</span></div></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_1Zmi">Copy</button></div></pre><p>In order to allow configuring Cassandra with the DC and Rack information, we use a specific <a href="https://github.com/Orange-OpenSource/cassandra-image/">Cassandra
Image</a>, which has a startup script that will retrieve
theses environment variables, and configure the Cassandra <code>cassandra-rackdc.properties</code> file with the values for dc and
rack.</p><p>The Cassandra Image makes us of the <code>GossipingPropertyFileSnitch</code> Cassandra Snitch, so that both Kubernetes and
Cassandra are aware of the chosen topology.</p></div></article><div class="margin-vert--xl"><div class="row"><div class="col"><a href="https://erdrix.github.io/casskop/edit/master/website/docs/casskop/2_deployment_configuration/6_cluster_topology.md" target="_blank" rel="noreferrer noopener"><svg fill="currentColor" height="1.2em" width="1.2em" preserveAspectRatio="xMidYMid meet" viewBox="0 0 40 40" style="margin-right:0.3em;vertical-align:sub"><g><path d="m34.5 11.7l-3 3.1-6.3-6.3 3.1-3q0.5-0.5 1.2-0.5t1.1 0.5l3.9 3.9q0.5 0.4 0.5 1.1t-0.5 1.2z m-29.5 17.1l18.4-18.5 6.3 6.3-18.4 18.4h-6.3v-6.2z"></path></g></svg>Edit this page</a></div></div></div><div class="margin-vert--lg"><nav class="pagination-nav"><div class="pagination-nav__item"><a class="pagination-nav__link" href="/casskop/docs/casskop/2_deployment_configuration/5_cpu_memory_resources"><h5 class="pagination-nav__link--sublabel">Previous</h5><h4 class="pagination-nav__link--label">Â« CPU and memory resources</h4></a></div><div class="pagination-nav__item pagination-nav__item--next"><a class="pagination-nav__link" href="/casskop/docs/casskop/2_deployment_configuration/7_implementation_architecture"><h5 class="pagination-nav__link--sublabel">Next</h5><h4 class="pagination-nav__link--label">Implementation architecture Â»</h4></a></div></nav></div></div></div><div class="col col--3"><div class="tableOfContents_TbNY"><ul class="contents contents__left-border"><li><a href="#quick-overview" class="contents__link">Quick overview</a></li><li><a href="#kubernetes-nodes-labels" class="contents__link">Kubernetes nodes labels</a></li><li><a href="#configuring-pod-scheduling" class="contents__link">Configuring pod scheduling</a><ul><li><a href="#cassandra-node-placement-in-the-kubernetes-cluster" class="contents__link">Cassandra node placement in the Kubernetes cluster</a></li><li><a href="#configuring-hard-antiaffinity-in-cassandra-cluster" class="contents__link">Configuring hard antiAffinity in Cassandra cluster</a></li></ul></li><li><a href="#cassandra-notion-of-dc-and-racks" class="contents__link">Cassandra notion of dc and racks</a></li><li><a href="#configure-the-cassandracluster-crd-for-dc--rack" class="contents__link">Configure the CassandraCluster CRD for dc & rack</a><ul><li><a href="#how-casskop-configures-dc-and-rack-in-cassandra" class="contents__link">How CassKop configures dc and rack in Cassandra</a></li></ul></li></ul></div></div></div></div></div></main></div></div><footer class="footer footer--dark"><div class="container"><div class="row footer__links"><div class="col footer__col"><h4 class="footer__title">Getting Started</h4><ul class="footer__items"><li class="footer__item"><a class="footer__link-item" href="/casskop/docs/overview">Documentation</a></li><li class="footer__item"><a class="footer__link-item" target="_blank" rel="noopener noreferrer" href="https://github.com/Orange-OpenSource/casskop">GitHub</a></li></ul></div><div class="col footer__col"><h4 class="footer__title">Community</h4><ul class="footer__items"><li class="footer__item"><a class="footer__link-item" target="_blank" rel="noopener noreferrer" href="https://casskop.slack.com">Slack</a></li><li class="footer__item"><a class="footer__link-item" href="/casskop/blog">Blog</a></li><li class="footer__item"><a class="footer__link-item" target="_blank" rel="noopener noreferrer" href="https://twitter.com">Twitter</a></li></ul></div><div class="col footer__col"><h4 class="footer__title">Contact</h4><ul class="footer__items"><li class="footer__item"><a class="footer__link-item" target="_blank" rel="noopener noreferrer" href="mailto:prj.casskop.support@list.orangeportails.net">Email</a></li><li class="footer__item"><a class="footer__link-item" target="_blank" rel="noopener noreferrer" href="https://github.com/Orange-OpenSource/casskop/issues">Feature request</a></li></ul></div></div><div class="text--center">Copyright Â© 2020 Orange, Inc. Built with Docusaurus.</div></div></footer>
</div>

<script src="/casskop/styles.01bd69bb.js"></script>

<script src="/casskop/runtime~main.f5598515.js"></script>

<script src="/casskop/main.1e1e5e5f.js"></script>

<script src="/casskop/1.24070d49.js"></script>

<script src="/casskop/2.3c1bdb43.js"></script>

<script src="/casskop/1be78505.72d8905a.js"></script>

<script src="/casskop/3cde0363.a5898433.js"></script>

<script src="/casskop/17896441.0273ebd2.js"></script>

<script src="/casskop/9707725f.2e2f18d3.js"></script>


</body>
</html>