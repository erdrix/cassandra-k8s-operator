(window.webpackJsonp=window.webpackJsonp||[]).push([[16],{143:function(e,n,a){"use strict";a.r(n),a.d(n,"frontMatter",(function(){return c})),a.d(n,"metadata",(function(){return s})),a.d(n,"rightToc",(function(){return l})),a.d(n,"default",(function(){return d}));var t=a(1),o=a(9),r=(a(0),a(182)),c={id:"4_troubleshooting",title:"Troubleshooting",sidebar_label:"Troubleshooting"},s={id:"casskop/4_troubleshooting",title:"Troubleshooting",description:"## GKE Specifics",source:"@site/docs/casskop/4_troubleshooting.md",permalink:"/casskop/docs/casskop/4_troubleshooting",editUrl:"https://erdrix.github.io/casskop/edit/master/website/docs/casskop/4_troubleshooting.md",sidebar_label:"Troubleshooting",sidebar:"docs",previous:{title:"Cluster operations",permalink:"/casskop/docs/casskop/3_operations/3_cassandra_pods_operations"},next:{title:"Overview",permalink:"/casskop/docs/multi-casskop/1_overview"}},l=[{value:"GKE Specifics",id:"gke-specifics",children:[{value:"RBAC on Google Container Engine (GKE)",id:"rbac-on-google-container-engine-gke",children:[]},{value:"Pod and volumes can be scheduled in different zones using default provisioned",id:"pod-and-volumes-can-be-scheduled-in-different-zones-using-default-provisioned",children:[]}]},{value:"Operator can't perform the Action",id:"operator-cant-perform-the-action",children:[{value:"Example: can't ScaleUp",id:"example-cant-scaleup",children:[]},{value:"Example: can't add new rack in new DC",id:"example-cant-add-new-rack-in-new-dc",children:[]}]}],i={rightToc:l};function d(e){var n=e.components,a=Object(o.a)(e,["components"]);return Object(r.b)("wrapper",Object(t.a)({},i,a,{components:n,mdxType:"MDXLayout"}),Object(r.b)("h2",{id:"gke-specifics"},"GKE Specifics"),Object(r.b)("h3",{id:"rbac-on-google-container-engine-gke"},"RBAC on Google Container Engine (GKE)"),Object(r.b)("p",null,"When you try to create ",Object(r.b)("inlineCode",{parentName:"p"},"ClusterRole")," (",Object(r.b)("inlineCode",{parentName:"p"},"cassandra-operator"),", etc.) on GKE Kubernetes cluster, you will probably run into permission errors:"),Object(r.b)("pre",null,Object(r.b)("code",Object(t.a)({parentName:"pre"},{}),'<....>\nfailed to initialize cluster resources: roles.rbac.authorization.k8s.io\n"cassandra-operator" is forbidden: attempt to grant extra privileges:\n<....>\n')),Object(r.b)("p",null,"This is due to the way Container Engine checks permissions. From ",Object(r.b)("a",Object(t.a)({parentName:"p"},{href:"https://cloud.google.com/container-engine/docs/role-based-access-control"}),"Google Container Engine docs"),":"),Object(r.b)("blockquote",null,Object(r.b)("p",{parentName:"blockquote"},"Because of the way Container Engine checks permissions when you create a Role or ClusterRole, you must first create a RoleBinding that grants you all of the permissions included in the role you want to create.\nAn example workaround is to create a RoleBinding that gives your Google identity a cluster-admin role before attempting to create additional Role or ClusterRole permissions.\nThis is a known issue in the Beta release of Role-Based Access Control in Kubernetes and Container Engine version 1.6.")),Object(r.b)("p",null,"To overcome this, you must grant your current Google identity ",Object(r.b)("inlineCode",{parentName:"p"},"cluster-admin")," Role:"),Object(r.b)("pre",null,Object(r.b)("code",Object(t.a)({parentName:"pre"},{className:"language-console"}),'# get current google identity\n$ gcloud info | grep Account\nAccount: [myname@example.org]\n\n# grant cluster-admin to your current identity\n$ kubectl create clusterrolebinding myname-cluster-admin-binding --clusterrole=cluster-admin --user=myname@example.org\nClusterrolebinding "myname-cluster-admin-binding" created\n')),Object(r.b)("h3",{id:"pod-and-volumes-can-be-scheduled-in-different-zones-using-default-provisioned"},"Pod and volumes can be scheduled in different zones using default provisioned"),Object(r.b)("p",null,"The default provisioner in GKE does not have the ",Object(r.b)("inlineCode",{parentName:"p"},'volumeBindingMode: "WaitForFirstConsumer"')," option that can result in\na bad\nscheduling behaviour.\nWe use one of the following files to create a storage class:"),Object(r.b)("ul",null,Object(r.b)("li",{parentName:"ul"},"samples/gke-storage-standard-wait.yaml"),Object(r.b)("li",{parentName:"ul"},"samples/gke-storage-ssd-wait.yaml (if you have ssd disks)")),Object(r.b)("h2",{id:"operator-cant-perform-the-action"},"Operator can't perform the Action"),Object(r.b)("p",null,"If you ask to scale up or add a new DC, or ask for more resources, CassKop will ask Kubernetes to schedule as you\nrequested.\nBut sometimes it is not possible to achieve the change because of a lack of resources (memory/cpus) or because\nconstraints can't be satisfied (Kubernetes nodes with specific labels available...)"),Object(r.b)("p",null,"CassKop make uses of the PodDisruptionBudget to prevent CassKop to make some change on the CassandraCluster that could\nmake more than 1 Cassandra node at a time. "),Object(r.b)("p",null,"If you have a Pod stuck in ",Object(r.b)("strong",{parentName:"p"},"pending")," state, then you have at least 1 Pod in Disruption, and the PDB object will\nprevent you to make changes on statefulset because that mean that you will have more than 1 Cassandra down at a time."),Object(r.b)("pre",null,Object(r.b)("code",Object(t.a)({parentName:"pre"},{className:"language-console"}),"$ k get poddisruptionbudgets\nNAME             MIN AVAILABLE   MAX UNAVAILABLE   ALLOWED DISRUPTIONS   AGE\ncassandra-demo   N/A             1                 0                     12m\n")),Object(r.b)("p",null,"The Operator logs this line when there is disruption on the Cassandra cluster:"),Object(r.b)("pre",null,Object(r.b)("code",Object(t.a)({parentName:"pre"},{className:"language-log"}),"INFO[3037] Cluster has Disruption on Pods, we wait before applying any change to statefulset  cluster=cassandra-demo dc-rack=dc1-rack1\n")),Object(r.b)("h3",{id:"example-cant-scaleup"},"Example: can't ScaleUp"),Object(r.b)("p",null,"In this example I ask a ScaleUp but it can't perform :"),Object(r.b)("pre",null,Object(r.b)("code",Object(t.a)({parentName:"pre"},{className:"language-console"}),"$ k get pods\nNAME                                                              READY   STATUS    RESTARTS   AGE\ncassandra-demo-dc1-rack1-0                                        1/1     Running   0          16h\ncassandra-demo-dc1-rack1-1                                        0/1     Pending   0          12m\ncassandra-demo-dc1-rack2-0                                        1/1     Running   0          16h\ncassandra-demo-dc1-rack3-0                                        1/1     Running   0          16h\n")),Object(r.b)("p",null,"the cassandra-demo-dc1-rack1-1 pod is Pending and can't be scheduled."),Object(r.b)("p",null,"If we looked at the pod status we will see this message :"),Object(r.b)("pre",null,Object(r.b)("code",Object(t.a)({parentName:"pre"},{className:"language-console"}),"Warning  FailedScheduling   51s (x17 over 14m)    default-scheduler   0/6 nodes are available: 4 Insufficient cpu, 4 node(s) didn't match node selector.\n")),Object(r.b)("p",null,"Kubernetes can't find any Pod with sufficient cpu and matching kubernetes nodes labels we asked in the topology section."),Object(r.b)("p",null,"To fix this, we can either:"),Object(r.b)("ul",null,Object(r.b)("li",{parentName:"ul"},"reduce memory/cpu limits"),Object(r.b)("li",{parentName:"ul"},"add more kubernetes nodes that will satisfied our requirements."),Object(r.b)("li",{parentName:"ul"},"rollback the scaleUp Operation")),Object(r.b)("blockquote",null,Object(r.b)("p",{parentName:"blockquote"},"At this point, CassKop will wait indefinitely to the case to be Fix")),Object(r.b)("h4",{id:"rollback-scaleup-operation"},"Rollback ScaleUp operation"),Object(r.b)("p",null,"In order to rollback the operation, we need to revert the change on the ",Object(r.b)("inlineCode",{parentName:"p"},"nodesPerRacks")," parameter."),Object(r.b)("blockquote",null,Object(r.b)("p",{parentName:"blockquote"},"This is not sufficient")),Object(r.b)("p",null,"Because CassKop is actually performing another action on the cluster (ScaleUp) we can't scheduled a new operation to\nrollback since it has not finished.\nWe introduced a new parameter in the CRD to allow such changes when all the pods can't be scheduled:"),Object(r.b)("ul",null,Object(r.b)("li",{parentName:"ul"},Object(r.b)("inlineCode",{parentName:"li"},"Spec.unlockNextOperation: true"))),Object(r.b)("blockquote",null,Object(r.b)("p",{parentName:"blockquote"},Object(r.b)("em",{parentName:"p"},Object(r.b)("strong",{parentName:"em"},"\ud83d\udea9 Warning")," This is not a regular parameter and it must be used with very good care!!."))),Object(r.b)("p",null,"By adding this parameter in our cluster definition, CassKop will allow to trigger a new operation."),Object(r.b)("blockquote",null,Object(r.b)("p",{parentName:"blockquote"},"Once CassKop has scheduled the new operation, it will reset this parameter to the default ",Object(r.b)("inlineCode",{parentName:"p"},"false")," value.\nvalue. If you need more operation, you will need to reset the parameter to force another Operation.\nKeep in mind that CassKop is mean to do only 1 operation at a time.")),Object(r.b)("p",null,"If this is not already done, you can now rollback the scaleUp updating ",Object(r.b)("inlineCode",{parentName:"p"},"nodesPerRacks: 1")),Object(r.b)("pre",null,Object(r.b)("code",Object(t.a)({parentName:"pre"},{className:"language-log"}),'WARN[3348] ScaleDown detected on a pending Pod. we don\'t launch decommission  cluster=cassandra-demo pod=cassandra-demo-dc1-rack1-1 rack=dc1-rack1\nINFO[3350] Cluster has 1 Pod Disrupted but that may be normal as we are decommissioning  cluster=cassandra-demo\ndc-rack=dc1-rack1\n...\nINFO[3354] [cassandra-demo][dc1-rack1]: StatefulSet(ScaleDown): Replicas Number OK: ready[1] \nINFO[3354] ScaleDown not yet Completed: Waiting for Pod operation to be Done  cluster=cassandra-demo rack=dc1-rack1\nINFO[3354] Decommission done -> we delete PVC            cluster=cassandra-demo pvc=data-cassandra-demo-dc1-rack1-1 rack=dc1-rack1\nINFO[3354] PVC deleted                                   cluster=cassandra-demo pvc=data-cassandra-demo-dc1-rack1-1 rack=dc1-rack1\nDEBU[3354] Waiting Rack to be running before continuing, we break ReconcileRack Without Updating Statefulset  cluster=cassandra-demo dc-rack=dc1-rack1 err="<nil>"\nINFO[3354] ScaleDown is Done                             cluster=cassandra-demo rack=dc1-rack1\n')),Object(r.b)("h3",{id:"example-cant-add-new-rack-in-new-dc"},"Example: can't add new rack in new DC"),Object(r.b)("p",null,"In this example, I ask to add dc called dc2"),Object(r.b)("pre",null,Object(r.b)("code",Object(t.a)({parentName:"pre"},{className:"language-console"}),"k get pods\nNAME                                                              READY   STATUS    RESTARTS   AGE\ncassandra-demo-dc1-rack1-0                                        1/1     Running   0          17h\ncassandra-demo-dc1-rack2-0                                        1/1     Running   0          17h\ncassandra-demo-dc1-rack3-0                                        1/1     Running   0          17h\ncassandra-demo-dc2-rack1-0                                        1/1     Running   0          5m46s\ncassandra-demo-dc2-rack2-0                                        1/1     Running   0          4m20s\ncassandra-demo-dc2-rack3-0                                        0/1     Pending   0          2m37s\n")),Object(r.b)("p",null,"But the last one can't be scheduled because of insufficient cpu on k8s nodes."),Object(r.b)("p",null,"We can either add the wanted resources in the k8s cluster or make a rollback."),Object(r.b)("h4",{id:"solution1-rollback-adding-the-dc"},"Solution1: rollback adding the DC"),Object(r.b)("p",null,"To rollback the add of the new DC, we first need to scale down to 0 for the nodes that already have join the ring.\nWe need to allow disruption as we do in previous section."),Object(r.b)("p",null,"then We first need to ask the dc2 to scaleDown to 0 because it has already add 2 racks, and we add the\nspec.unlockNextOperation to true."),Object(r.b)("pre",null,Object(r.b)("code",Object(t.a)({parentName:"pre"},{className:"language-yaml"}),"...\n  unlockNextOperation: true\n  ...\n    name: dc2\n    nodesPerRacks: 0\n")),Object(r.b)("p",null,"This will allow CassKop to make the scale down. because it will start with the first rack, it will free some space and\nthe last pod which was pending will be joining. then it will be decommissioned by CassKop."),Object(r.b)("p",null,"we can see in CassKop logs when it deal with the rack with unscheduled pods:"),Object(r.b)("pre",null,Object(r.b)("code",Object(t.a)({parentName:"pre"},{className:"language-log"}),"WARN[0667] Aborting Initializing..., start ScaleDown                      cluster=cassandra-demo rack=dc2-rack3\nINFO[0667] The Operator Waits 20 seconds for the action to start correctly  cluster=cassandra-demo rack=dc2-rack3\nWARN[0667] ScaleDown detected on a pending Pod. we don't launch decommission  cluster=cassandra-demo pod=cassandra-demo-dc2-rack3-0 rack=dc2-rack3\nINFO[0667] Cluster has 1 Pod Disrupted but that may be normal as we are decommissioning\ncluster=cassandra-demodc-rack=dc2-rack3\nINFO[0667] Template is different:  {...}\n")),Object(r.b)("p",null,"It will also ScaleDown any pods that was part of the new DC."),Object(r.b)("blockquote",null,Object(r.b)("p",{parentName:"blockquote"},"Once ScaleDown is done, you can delete the DC from the Spec.")),Object(r.b)("h4",{id:"solution2-change-the-topology-for-dc2-remove-the-3rd-unschedulable-rack"},"Solution2: change the topology for dc2 (remove the 3rd unschedulable rack)"),Object(r.b)("p",null,"we get back in the previous section before making the rolling back of adding the dc2."),Object(r.b)("p",null,"If only one of the Racks can't schedule any pods, we can change the topology to remove the Rack ONLY if there was not already\npods deployed in the Rack. If this is not the case, then you will need to process ScaleDown instead of removing rack."),Object(r.b)("pre",null,Object(r.b)("code",Object(t.a)({parentName:"pre"},{className:"language-yaml"}),"    - labels:\n        failure-domain.beta.kubernetes.io/region: europe-west1\n      name: dc2\n      nodesPerRacks: 1\n      numTokens: 256\n      rack:\n      - labels:\n          failure-domain.beta.kubernetes.io/zone: europe-west1-d\n        name: rack1\n      - labels:\n          failure-domain.beta.kubernetes.io/zone: europe-west1-c\n        name: rack2\n      - labels:\n          failure-domain.beta.kubernetes.io/zone: europe-west1-d\n        name: rack3\n")),Object(r.b)("p",null,"let's remove the rack3 from dc2."),Object(r.b)("p",null,"the operator will log :"),Object(r.b)("pre",null,Object(r.b)("code",Object(t.a)({parentName:"pre"},{className:"language-log"}),"WARN[0347] We asked to remove Rack dc2-rack3 with unschedulable pod  cluster=cassandra-demo\nINFO[0347] [cassandra-demo]: Delete PVC[data-cassandra-demo-dc2-rack3-0] OK \n")),Object(r.b)("p",null,"The rack3 (and its statefulset) has been removed, and the associated (empty) pvc deleted"))}d.isMDXComponent=!0},182:function(e,n,a){"use strict";a.d(n,"a",(function(){return u})),a.d(n,"b",(function(){return m}));var t=a(0),o=a.n(t);function r(e,n,a){return n in e?Object.defineProperty(e,n,{value:a,enumerable:!0,configurable:!0,writable:!0}):e[n]=a,e}function c(e,n){var a=Object.keys(e);if(Object.getOwnPropertySymbols){var t=Object.getOwnPropertySymbols(e);n&&(t=t.filter((function(n){return Object.getOwnPropertyDescriptor(e,n).enumerable}))),a.push.apply(a,t)}return a}function s(e){for(var n=1;n<arguments.length;n++){var a=null!=arguments[n]?arguments[n]:{};n%2?c(Object(a),!0).forEach((function(n){r(e,n,a[n])})):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(a)):c(Object(a)).forEach((function(n){Object.defineProperty(e,n,Object.getOwnPropertyDescriptor(a,n))}))}return e}function l(e,n){if(null==e)return{};var a,t,o=function(e,n){if(null==e)return{};var a,t,o={},r=Object.keys(e);for(t=0;t<r.length;t++)a=r[t],n.indexOf(a)>=0||(o[a]=e[a]);return o}(e,n);if(Object.getOwnPropertySymbols){var r=Object.getOwnPropertySymbols(e);for(t=0;t<r.length;t++)a=r[t],n.indexOf(a)>=0||Object.prototype.propertyIsEnumerable.call(e,a)&&(o[a]=e[a])}return o}var i=o.a.createContext({}),d=function(e){var n=o.a.useContext(i),a=n;return e&&(a="function"==typeof e?e(n):s({},n,{},e)),a},u=function(e){var n=d(e.components);return o.a.createElement(i.Provider,{value:n},e.children)},b={inlineCode:"code",wrapper:function(e){var n=e.children;return o.a.createElement(o.a.Fragment,{},n)}},p=Object(t.forwardRef)((function(e,n){var a=e.components,t=e.mdxType,r=e.originalType,c=e.parentName,i=l(e,["components","mdxType","originalType","parentName"]),u=d(a),p=t,m=u["".concat(c,".").concat(p)]||u[p]||b[p]||r;return a?o.a.createElement(m,s({ref:n},i,{components:a})):o.a.createElement(m,s({ref:n},i))}));function m(e,n){var a=arguments,t=n&&n.mdxType;if("string"==typeof e||t){var r=a.length,c=new Array(r);c[0]=p;var s={};for(var l in n)hasOwnProperty.call(n,l)&&(s[l]=n[l]);s.originalType=e,s.mdxType="string"==typeof e?e:t,c[1]=s;for(var i=2;i<r;i++)c[i]=a[i];return o.a.createElement.apply(null,c)}return o.a.createElement.apply(null,a)}p.displayName="MDXCreateElement"}}]);